# Authentication and Authorization

referensi: https://hasura.io/docs/latest/auth/overview/

Autentikasi dan otorisasi dapat dilakukan dan juga sudah disediakan di hasura, untuk authentikasi sendiri, terdapat beberapa metode seperti penggunaan [JWT](https://hasura.io/docs/latest/auth/authentication/jwt/) dan juga menggunakan [webhook](https://hasura.io/docs/latest/auth/authentication/webhook/) sebagai optionnya.

Sebagai permulaan, saya akan mencoba praktek auth sederhana dengan berpedoman di [tutorial ini](https://hasura.io/docs/latest/auth/quickstart/) yang menggunakan JWT untuk otentikasinya kemudian akan mengotorisasi query get user yang mana saat sudah login dan dikenali sebagai user melalui token JWT yang dimiliki, maka query hanya akan menampilkan profil user yang login terebut saja.

### Menambahkan env variable

Untuk mempercepat prosesnya, disini sudah disediakan JWT secret yang berisi tipe algoritma untuk sign jwt serta key yang digunakan memverivikasi tokennya.

karena HGE saya di instance di docker, maka saya memasukan env ke `docker-compose.yml` dan run ulang dengan `docker compose up -d` untuk menerapkan perubahannya.

```
HASURA_GRAPHQL_JWT_SECRET: '{ "type": "HS256", "key": "oursupersecretsupersecurekey1234567890" }'
```

### Membuat dan Mengisi tabel `users`

Karena sesi kali ini ingin mencoba untuk get data user, maka buat dan isi terlebih dahulu tabel `users`, dapat dibuat dan input manual di console hasura atau jalankan di tab `data`-> `Raw SQL`, lalu masukan query ini:

```
CREATE TABLE users (
  id uuid NOT NULL,
  name text NOT NULL,
  email text NOT NULL,
  PRIMARY KEY (id)
);

INSERT INTO public.users (id, name, email) VALUES ('7cf0a66c-65b7-11ed-b904-fb49f034fbbb', 'Sean', 'seandemo@hasura.io');
INSERT INTO public.users (id, name, email) VALUES ('82001336-65b7-11ed-b905-7fa26a16d198', 'Rob', 'robdemo@hasura.io');
INSERT INTO public.users (id, name, email) VALUES ('86d5fba0-65b7-11ed-b906-afb985970e2e', 'Marion', 'mariondemo@hasura.io');
INSERT INTO public.users (id, name, email) VALUES ('8dea1160-65b7-11ed-b907-e3c5123cb650', 'Sandeep', 'sandeepdemo@hasura.io');
INSERT INTO public.users (id, name, email) VALUES ('9bd9d300-65b7-11ed-b908-571fef22d2ba', 'Abby', 'abbydemo@hasura.io');
```

### Buat dan setting role user

Navigasi ke tabel `users` yang telah dibuat kemudian ketikan role baru yaitu `user` dan klik pada bagian `select` untuk mengatur query select pada database sebagai role `user`

Pada `row select permission` klik di `With custom check` dan masukan nilai ini: ```{ "id": { "_eq": "X-Hasura-User-Id" } }```

Aturan tersebut kemudian akan secara otomatis membuat query select yang dilakukan role user untuk memfilter value pada row sesuai dengan id user yang ada dalam header `X-Hasura-User-Id`

![image](https://github.com/user-attachments/assets/c0054a1a-5255-4b6a-82e7-4368e435e4c2)

Selain itu, terdapat juga pengaturan untuk izin select kolom yang juga dapat membatasi kolom mana saja yang dapat di select oleh role tertentu, jika ingin memperbolehkan semuanya, klik `toggle all`.

### Menambah header `Authorization`

Sebagai penerapan otentikasi menggunakan JWT, diperlukan encoded JWT berbentuk bearer yang didapatkan dari payload berupa beberapa data seperti header dsb. berikut adalah isi untuk mengisi header `authorization`:

```
Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IlNlYW4iLCJlbWFpbCI6InNlYW5kZW1vQGhhc3VyYS5pbyIsImlhdCI6MTUxNjIzOTAyMiwiaHR0cHM6Ly9oYXN1cmEuaW8vand0L2NsYWltcyI6eyJ4LWhhc3VyYS1hbGxvd2VkLXJvbGVzIjpbInVzZXIiLCJhZG1pbiJdLCJ4LWhhc3VyYS1kZWZhdWx0LXJvbGUiOiJ1c2VyIiwieC1oYXN1cmEtdXNlci1pZCI6IjdjZjBhNjZjLTY1YjctMTFlZC1iOTA0LWZiNDlmMDM0ZmJiYiJ9fQ.jSp42PsCa4r-2ObfopkiDBvTn9nDysIv-NOIEnU3wR0
```

### Testing query

jalankan query berikut dengan masih menceklis header `x-hasura-admin-secret` dan `Authorization` :

```
query GetUsers {
  users {
    id
    email
    name
  }
}
```

outputnya akan menampilkan seluruh data user yang ada karena masih dikenali sebagai role admin

![image](https://github.com/user-attachments/assets/704aca5a-abbf-4709-aa5d-8b29807aaba2)

Jika header `x-hasura-admin-secret` di uncheck, dan query yang sama di run maka hasilnya menjadi seperti berikut:

![image](https://github.com/user-attachments/assets/0d1d2c82-603c-41ab-b472-472c7d75b83c)

Output yang didapatkan akan menampilkan data user yang hanya sesuai dengan ID user yang sama dengan yang ada di bearer token, jadi hal ini dapat membatasi user lain untuk mengakses data dari user lainnya.

Jika korsor di navigasi ke bearer token di pojok kanan akan muncul decode JWT yang berisi hasil decode token bearer dan dapat dilihat detail apa saja yang terkandung dalam token tersebut seperti berikut:

![image](https://github.com/user-attachments/assets/f9620a7e-e666-4bff-9d9a-640a6d0b0650)

![image](https://github.com/user-attachments/assets/78624681-1b99-43cf-9f64-a6923adb562b)

Dalam token terkandung `x-hasura-default-role` sebagai user dan `X-Hasura-User-Id` nya, kemudian karena sebelumnya sudah di setting permission getUsers untuk role user hanya id pada tabel `users` yang equal dengan `X-Hasura-User-Id`, maka akan menampilkan row pada tabel `users` di database yang sesuai saja dengan `X-Hasura-User-Id`.
